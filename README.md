# Smart Campus Canteen · 校园智慧点餐与评分系统

一个基于 **FastAPI + SQLite + 原生前端** 的校园食堂点餐与评分系统。功能包括多食堂菜单浏览、在线点餐、菜品评分与评论、智能推荐、菜品可选项配置、中英双语界面，以及简易聊天助手。

---

## 1. 项目结构概览

本项目采用“后端 API + 静态前端”的结构，主要目录与文件说明如下：

- **`app/`**  
  FastAPI 应用核心目录，包含：
  - 应用入口与生命周期管理。
  - 数据库工具与初始化 / 迁移逻辑。
  - Pydantic 数据模型。
  - 业务路由模块（用户认证、食堂、菜品、评分、订单、统计、菜品选项配置、聊天助手等）。

- **`static/`**  
  静态前端资源目录，包含：
  - 单页应用入口页面（整体 UI 和布局）。
  - 样式文件（Dashboard 布局、表单、购物车、聊天窗口等）。
  - 前端逻辑脚本（与后端 API 通信、状态管理、多语言切换等）。

- **根目录其他文件**  
  - `schema.sql`：定义完整的数据库模式（所有表结构）。  
  - `canteen.db`：运行时使用的 SQLite 数据库文件。  
  - `seed_dish_options.py`：初始化菜品可选项配置脚本。  
  - `update_ingredients_zh.py`：批量更新菜品中文食材信息脚本。  
  - `update_users.py`：与用户数据或结构更新相关的脚本。  
  - `requirements.txt`：Python 依赖列表。  
  - `.env`：本地环境变量配置（不提交到 Git）。  
  - `.gitignore`：Git 忽略规则。  
  - `readmezh.md`：早期版本的简要中文说明。

---

## 2. 数据库模式（Database Schema）

项目使用 SQLite 作为持久化存储，所有表结构定义在 `schema.sql` 中，并由 `app/db.py` 中的初始化函数在应用启动时自动创建或迁移。数据库启用了外键约束，以确保不同实体之间的关联关系一致。

系统主要包含以下实体及关系：

### 2.1 用户（users）

- 用途：存储系统用户账户信息（例如学生、管理员等）。
- 主要信息：
  - 自增主键 ID。
  - 唯一的用户名。
  - 可选邮箱地址。
  - 密码哈希值（而非明文密码）。
  - 用户角色（默认角色为学生，可拓展为管理员等）。
  - 账户创建时间与最近登录时间。
- 关系：
  - 与评分记录（ratings）存在一对多关系。
  - 与订单（orders）存在一对多关系。
  - 与收藏记录（favorites）存在一对多关系。

### 2.2 食堂（canteens）

- 用途：描述校园内的各个食堂。
- 主要信息：
  - 自增主键 ID。
  - 食堂名称。
  - 位置信息。
  - 文字描述。
- 关系：
  - 与菜品（dishes）为一对多关系，即一个食堂包含多道菜品。

### 2.3 菜品（dishes）

- 用途：存储每道菜的基础信息。
- 主要信息：
  - 自增主键 ID。
  - 所属食堂 ID（外键）。
  - 菜品名称。
  - 所在档口或类别。
  - 价格。
  - 食材信息（英文）。
  - 食材信息（中文）。
  - 卡路里数据。
  - 是否在售标志。
  - 创建时间。
- 关系：
  - 与评分（ratings）为一对多关系。
  - 与订单明细（order_items）为一对多关系。
  - 与菜品选项配置（dish_option_configs）为一对多关系。
  - 与收藏（favorites）为一对多关系。

### 2.4 评分与评论（ratings）

- 用途：记录用户对菜品的星级评分与文字评论。
- 主要信息：
  - 自增主键 ID。
  - 用户 ID（外键，关联 users）。
  - 菜品 ID（外键，关联 dishes）。
  - 评分分值（限定在合理区间，例如 1–5 分）。
  - 可选评论内容。
  - 创建时间。
- 约束：
  - 同一用户对同一菜品最多只允许一条记录，通过联合唯一约束实现。

### 2.5 订单与订单明细（orders, order_items）

**订单（orders）：**

- 用途：记录每次下单的整体信息。
- 主要信息：
  - 自增主键 ID。
  - 下单用户 ID（外键）。
  - 订单总价格。
  - 订单状态（例如已创建、已支付、已完成等）。
  - 创建时间。
- 关系：
  - 与订单明细表为一对多关系，一个订单包含多条明细。

**订单明细（order_items）：**

- 用途：记录订单中的每一道菜品及其数量和价格信息。
- 主要信息：
  - 自增主键 ID。
  - 所属订单 ID（外键，关联 orders）。
  - 菜品 ID（外键，关联 dishes）。
  - 菜品数量（必须为正数）。
  - 单价（一般为基础价格加上选项附加价）。
  - 选项信息（以文本形式存储，通常是 JSON 字符串，记录加蛋、辣度等配置）。
- 约束与行为：
  - 当订单被删除时，其明细会被级联删除。
  - 当菜品被删除时，与之相关的订单明细也会进行相应处理。

### 2.6 菜品选项配置（dish_option_configs）

- 用途：描述某道菜可配置的选项，例如加料、辣度、冰量、糖度等。
- 主要信息：
  - 自增主键 ID。
  - 菜品 ID（外键，关联 dishes）。
  - 选项类型标识（例如加蛋、辣度等级等的内部编码）。
  - 选项名称（中文）。
  - 选项名称（英文）。
  - 可选值集合（序列化形式，一般存储每个选项值及其显示名称和价格变化信息）。
  - 是否为必选项（布尔含义）。
- 应用场景：
  - 前端根据该表生成菜品详情中的可选项控件，供用户自定义口味和加料。

### 2.7 收藏（favorites）

- 用途：记录用户收藏的菜品。
- 特性：
  - 使用联合主键（用户 ID + 菜品 ID）保证同一用户不会重复收藏同一道菜。
  - 与用户表和菜品表通过外键相连，在用户或菜品删除时进行数据清理。
- 应用场景：
  - 支持收藏夹、个性化推荐等扩展功能。

---

## 3. 后端逻辑（FastAPI 应用）

后端采用 FastAPI 实现，负责暴露 RESTful API、处理业务逻辑、访问数据库，并向浏览器提供静态前端页面。

### 3.1 应用入口与生命周期管理

- 应用入口位于 `app` 目录下的主程序文件：
  - 加载项目根目录下的 `.env` 文件，从中读取数据库路径、外部服务地址和秘钥等配置。
  - 在启动事件中调用数据库初始化函数，对 `schema.sql` 中定义的模式进行创建或迁移。
- 静态文件服务：
  - 根路径用于返回主页面。
  - 特定路径挂载静态资源（如 `/static`），供浏览器加载 CSS 和 JS。

### 3.2 数据库访问与初始化

- 数据库工具模块负责：
  - 建立与 SQLite 数据库文件的连接，并设置结果的行格式方便转为字典。  
  - 在应用启动时：
    - 若数据库文件尚未初始化，则根据 `schema.sql` 创建全部表结构。  
    - 若数据库已存在，则尝试通过增加字段、创建新表等方式进行增量迁移，以兼容旧数据。
- 这种设计允许在不清空数据的前提下逐步演化数据库结构（例如为用户表增加邮箱和最近登录时间、为菜品表增加中英文食材和卡路里字段、为订单项增加选项字段等）。

### 3.3 Pydantic 数据模型

- Pydantic 模型用于描述和验证 API 的输入输出数据结构。  
- 为核心实体（如食堂、菜品、评分、用户等）定义字段类型与约束：
  - 确保客户端提交的请求数据合法（如评分分值在有效范围内）。
  - 明确接口返回的数据字段，便于前端消费。

### 3.4 路由与业务模块

业务接口按照功能拆分在 `app/routers/` 目录中，每个文件对应一类业务逻辑：

- **认证模块（auth）**  
  处理用户注册与登录，请求中包含用户名、密码等信息，响应中返回登录结果与用户信息，并可扩展为基于令牌的鉴权机制。

- **食堂模块（canteens）**  
  提供食堂列表及基本信息的查询接口。  
  支持按食堂 ID 获取其下属的菜品列表，为前端菜单树提供数据来源。

- **菜品模块（dishes）**  
  提供菜品列表与详情查询接口，可按食堂或类别过滤。  
  可用于展示所有菜品、按条件检索等场景。

- **评分模块（ratings）**  
  提供对某道菜的评分列表查询接口，以及提交新评分与评论的接口。  
  通过业务逻辑保证一个用户对同一道菜只能评分一次，重复评分会进行更新或拒绝处理（视具体实现而定）。

- **订单模块（orders）**  
  接收来自前端购物车的信息，创建订单与订单明细记录。  
  支持查询某一用户的历史订单，用于“我的订单”页面展示。  
  订单状态字段可用于区分不同业务流程阶段（如已创建、已支付等）。

- **统计模块（stats）**  
  提供聚合统计类接口，例如：
  - 某菜品的平均评分和评分数量。  
  - 各食堂或某段时间内的热门菜品。  
  这些数据可用于推荐页面或管理后台分析。

- **菜品选项模块（options）**  
  基于 `dish_option_configs` 表，为前端返回指定菜品的选项配置列表。  
  前端据此生成加蛋、辣度、冰量、糖度等可选项控件，并在计算总价时考虑附加费用。

- **聊天助手模块（chat）**  
  提供聊天接口，将前端输入的问题转发到后端逻辑处理：
  - 可以对接外部大模型 API（例如根据 .env 中的配置）。  
  - 也可以通过规则引擎给出简单回复，例如推荐菜品、解释菜单等。  
  返回内容会显示在前端“点餐助手”聊天窗口中。

---

## 4. 前端结构与交互（static）

前端部分采用原生 HTML、CSS 与 JavaScript 实现，无需额外的前端框架即可运行。

### 4.1 页面结构

- 左侧侧边栏：
  - 显示项目 logo 和名称。  
  - 提供视图切换按钮（浏览菜单、每日推荐、我的订单）。  
  - 提供中英文语言切换按钮。

- 中间主内容区：
  - **菜单视图**：
    - 左侧为食堂与菜品树状菜单，可展开食堂查看其中的菜品。  
    - 中间为菜品详情区，展示菜名、价格、类别、卡路里和食材信息。  
    - 详情区中有菜品可选项设置区域，根据后端的选项配置动态渲染。  
    - 下方是用户评分列表以及“添加评分”表单（星级+评论）。
  - **推荐视图**：
    - 展示“今日推荐”和“本周推荐”的菜品卡片。  
    - 配合后端统计接口展示有代表性的推荐结果。
  - **订单视图**：
    - 用于显示当前用户的历史订单（如果已有实现），或给出空状态占位界面。

- 右侧购物车面板：
  - 列出当前已加入购物车的菜品，展示数量、单价与选项信息。  
  - 计算并展示购物车总价。  
  - 提供“去结算”按钮，点击后弹出结算/支付模态框，展示订单摘要并确认下单。

- 其他弹窗与组件：
  - 登录/注册模态框：切换标签在两种表单间切换。  
  - 结算模态框：展示订单明细和总价，确认支付操作。  
  - 右下角聊天窗口：用于与后端聊天助手交互。

### 4.2 样式与 UI

- 使用统一的色彩与圆角、阴影设计，打造类似现代后台管理系统的 Dashboard 风格。  
- 对菜单树、详情卡片、购物车、按钮、星级评分控件、模态框、聊天窗口等元素进行细致的样式美化。  
- 定制滚动条和悬停效果，使界面更加现代和易用。  
- 对窄屏场景进行了基本适配，保证主要功能在不同分辨率下可用。

### 4.3 前端逻辑与交互

前端脚本主要负责：

- **与后端 API 通信**：
  - 统一封装请求方法，处理错误提示和返回数据解析。  
  - 调用后端提供的食堂、菜品、评分、订单、统计、选项和聊天等接口。

- **状态管理**：
  - 维护当前登录用户信息，并使用本地存储在刷新后恢复。  
  - 维护当前购物车内容，包括每一项菜品的数量、选项选择和价格。  
  - 维护当前语言设置，并在切换语言时更新界面文本和部分数据展示。

- **界面渲染与事件处理**：
  - 根据后端返回的数据动态构建食堂与菜品树状菜单。  
  - 在用户选择某道菜时加载该菜的详情、评分和可选项，并允许加入购物车。  
  - 实时更新购物车界面、合计金额以及结算按钮状态。  
  - 处理登录 / 注册表单的提交结果，并更新右上角用户状态显示。  
  - 管理聊天窗口的开关和消息流，显示用户和助手的对话内容。

- **多语言支持**：
  - 内置英文和中文两套界面文案。  
  - 提供菜品名、食堂名、类别名的中英文对照，使得菜单在双语切换时保持一致。  
  - 切换语言时不仅更新界面文本，也会更新菜品名称、食材描述和部分提示文案。

---

## 5. 数据生成与测试脚本

为了便于初始化和演示，本项目提供了若干脚本对数据库进行数据填充和更新：

- **菜品选项初始化脚本**（`seed_dish_options.py`）
  - 为指定菜品创建对应的选项配置，如加蛋、加肉、辣度、冰量、糖度等。  
  - 在数据库中写入结构化的选项定义，前端据此动态渲染选项控件并计算附加价格。

- **食材信息更新脚本**（`update_ingredients_zh.py`）
  - 批量填充或更新菜品的中文食材描述字段。  
  - 与英文食材字段结合，用于在不同语言界面下展示对应的食材说明。

- **用户与数据更新脚本**（`update_users.py`）
  - 用于在数据库结构变化或测试阶段，对用户表进行数据修复、补充或初始化测试用户。  
  - 便于在本地快速构造具备一定真实度的使用场景（有真实用户、有评分、有订单等）。

这些脚本通常在本地开发或演示阶段按需手动运行，在生产环境下使用时需要结合具体运维策略谨慎操作。

---

## 6. 依赖关系与环境配置

### 6.1 主要依赖

后端主要依赖如下组件（详见 `requirements.txt`）：

- FastAPI：构建 Web API 的异步框架。
- Uvicorn：ASGI 服务器，用于运行 FastAPI 应用。
- Pydantic：数据模型与校验库（包含 E-mail 字段相关扩展）。
- python-dotenv：从 `.env` 文件中加载环境变量。
- （可选）HTTP 客户端库：供聊天模块或其他扩展功能调用外部 API 使用。

### 6.2 环境变量

- 项目根目录下的 `.env` 文件用于配置本地环境，例如：
  - 数据库连接字符串（若需自定义）。
  - 聊天助手使用的外部模型服务地址、API Key 等（如有集成）。
- `.env` 已加入 `.gitignore`，不会被提交到 GitHub，以避免泄露敏感信息。

---
## 7. 如何运行本项目

以下为在本地运行项目的一般步骤（假设已安装 Python）：

1. **克隆代码仓库**  
   使用 Git 将仓库克隆到本地工作目录，并进入项目根目录

2. **创建并激活虚拟环境**  

   在项目根目录创建虚拟环境，并根据操作系统激活。

   - Windows 示例：

     ```bash
     python -m venv venv

     venv\Scripts\activate
     ```

   - macOS / Linux 示例：

     ```bash
     python3 -m venv venv
     source venv/bin/activate
     ```

3. **安装后端依赖**  

   在虚拟环境激活的前提下，使用包管理工具读取 `requirements.txt`，一次性安装所有所需依赖：

   ```bash
   pip install -r requirements.txt
   ```

4. **配置环境变量**  

   在项目根目录创建 `.env` 文件，根据需要配置，例如：

   ```env
   # 示例：如不配置则会使用默认 SQLite 文件
   DATABASE_URL=sqlite:///./canteen.db

   # 如聊天模块需要外部大模型服务，可在此配置
   # LLM_API_KEY=your-api-key
   # LLM_BASE_URL=https://your-llm-endpoint
   ```

5. **初始化 / 迁移数据库**  

   启动 FastAPI 应用时，数据库初始化逻辑会自动执行：
   - 如果数据库文件不存在，则根据 `schema.sql` 创建所有表结构。  
   - 如果数据库已存在，则尝试增量迁移以添加新字段或新表。  

   如需演示完整功能，可在此阶段按需运行数据脚本填充数据，例如：

   ```bash
   python seed_dish_options.py
   python update_ingredients_zh.py
   python update_users.py
   ```

6. **启动开发服务器**  

   使用 ASGI 服务器在本地启动应用，并开启自动重载功能，方便开发调试。以你当前的启动方式为例：

   ```bash
   uvicorn app.main:app --reload
   ```

   启动成功后，可在浏览器中访问：

   - Web 界面：`http://127.0.0.1:8000/`（主入口页面，用于实际点餐和评分操作）。  
   - API 文档：  
     - Swagger UI：`http://127.0.0.1:8000/docs`  
     - ReDoc：`http://127.0.0.1:8000/redoc`

7. **在浏览器中体验功能**  

   - 浏览各食堂及其菜品，切换中英双语界面。  
   - 注册或登录用户账户，给菜品评分和评论。  
   - 将菜品及其可选项加入购物车，进行下单和结算体验。  
   - 查看推荐页面和历史订单。  
   - 打开右下角聊天助手，与后端聊天接口进行点餐问答（若已配置外部模型服务）。


---
